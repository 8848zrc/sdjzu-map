<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建大活地图 - 管理后台</title>
    <!-- 引入 Vue 3 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js" crossorigin="anonymous"></script>
    <!-- 引入 LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js" crossorigin="anonymous"></script>
    <!-- 引入 Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'PingFang SC', sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: #333; }
        
        /* 登录框样式 */
        .login-box { text-align: center; margin-top: 50px; }
        .login-box input { padding: 10px; width: 200px; border: 1px solid #ddd; border-radius: 5px; }
        .login-box button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }

        /* 列表样式 */
        .marker-list { list-style: none; padding: 0; }
        .marker-item { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #eee; padding: 15px 0; 
        }
        .marker-info h4 { margin: 0 0 5px 0; font-size: 16px; }
        .marker-meta { font-size: 12px; color: #666; }
        .tag { padding: 2px 6px; border-radius: 4px; color: white; font-size: 12px; margin-right: 5px; }
        .tag.生活 { background-color: #28a745; }
        .tag.教学 { background-color: #17a2b8; }
        .tag.景观 { background-color: #fd7e14; }

        .btn-delete { background: #dc3545; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .btn-delete:hover { background: #c82333; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;}
        .refresh-btn { background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;}
    </style>
</head>
<body>

<div id="app" class="container">
    <!-- 1. 登录界面 -->
    <div v-if="!isAdmin" class="login-box">
        <h3>管理员登录</h3>
        <input type="password" v-model="password" placeholder="请输入管理员密码" @keyup.enter="login">
        <button @click="login">进入</button>
        <p style="color:red; font-size:12px; margin-top:10px;">{{ errorMsg }}</p>
    </div>

    <!-- 2. 管理列表界面 -->
    <div v-else>
        <div class="header-bar">
            <span>共 {{ markers.length }} 个标记点</span>
            <div>
                <button class="refresh-btn" @click="fetchData"><i class="fas fa-sync"></i> 刷新</button>
                <a href="./index.html" target="_blank" style="font-size:12px; margin-left:10px;">去地图页</a>
            </div>
        </div>

        <ul class="marker-list">
            <li v-for="item in markers" :key="item.id" class="marker-item">
                <div class="marker-info">
                    <h4>
                        <span class="tag" :class="item.type">{{ item.type }}</span>
                        {{ item.name }}
                    </h4>
                    <div class="marker-meta">
                        提交人: {{ item.author }} | 时间: {{ formatDate(item.createdAt) }}
                    </div>
                </div>
                <button class="btn-delete" @click="deleteMarker(item.id, item.name)">
                    <i class="fas fa-trash"></i> 删除
                </button>
            </li>
        </ul>
        <div v-if="markers.length === 0" style="text-align:center; color:#999; padding:20px;">
            暂无数据
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted } = Vue;

    // LeanCloud 配置 (与 index.html 保持一致)
    const LC_APP_ID = "ECKlruvoxNOQI6zyzg66t5h1-MdYXbMMI";
    const LC_APP_KEY = "B85feGjLyAiFP1OGroH89zfQ";
    const LC_SERVER_URL = "https://ecklruvo.api.lncldglobal.com";

    createApp({
        setup() {
            // --- 状态 ---
            const isAdmin = ref(false);
            const password = ref("");
            const errorMsg = ref("");
            const markers = ref([]);

            // --- 初始化 ---
            onMounted(() => {
                if (typeof AV !== 'undefined') {
                    AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: LC_SERVER_URL });
                }
                // 检查是否已经登录过
                if (localStorage.getItem('admin_token') === 'true') {
                    isAdmin.value = true;
                    fetchData();
                }
            });

            // --- 1. 登录逻辑 ---
            const login = () => {
                // 【密码在这里修改】 比如设置为 "jian123"
                if (password.value === "438455") { 
                    isAdmin.value = true;
                    localStorage.setItem('admin_token', 'true');
                    fetchData();
                } else {
                    errorMsg.value = "密码错误";
                }
            };

            // --- 2. 拉取数据 ---
            const fetchData = async () => {
                const query = new AV.Query('CampusMarkers');
                query.descending('createdAt'); // 最新的在前面
                query.limit(100);
                try {
                    const results = await query.find();
                    markers.value = results.map(r => ({
                        id: r.id,
                        ...r.toJSON()
                    }));
                } catch (error) {
                    alert("获取数据失败: " + error.message);
                }
            };

            // --- 3. 删除数据 ---
            const deleteMarker = async (id, name) => {
                if (!confirm(`确定要删除“${name}”吗？删除后无法恢复。`)) return;

                try {
                    const todo = AV.Object.createWithoutData('CampusMarkers', id);
                    await todo.destroy();
                    // 从本地列表移除，不用刷新
                    markers.value = markers.value.filter(m => m.id !== id);
                    alert("删除成功");
                } catch (error) {
                    alert("删除失败: " + error.message);
                }
            };

            // --- 工具: 格式化时间 ---
            const formatDate = (isoStr) => {
                const date = new Date(isoStr);
                return `${date.getMonth()+1}月${date.getDate()}日 ${date.getHours()}:${date.getMinutes()}`;
            };

            return { isAdmin, password, errorMsg, markers, login, fetchData, deleteMarker, formatDate };
        }
    }).mount('#app');
</script>

</body>
</html>