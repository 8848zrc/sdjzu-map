<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>山东建筑大学 - 活地图系统</title>
    
    <!-- 引入 Font Awesome 图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 【关键修改1】安全密钥必须在 loader.js 之前配置 -->
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: '03f00903b92206db88e84beb1a5e5bf3', 
        };
    </script>
    
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 高德地图 JSAPI Loader -->
    <script src="https://webapi.amap.com/loader.js"></script>
    <!-- 引入 LeanCloud SDK (云数据库) -->
    <script src="https://unpkg.com/leancloud-storage@4.15.0/dist/av-min.js"></script>
    
    <style>
        /* --- 基础样式 --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background-color: #f0f2f5; }
        #app { width: 100%; height: 100%; position: relative; }
        
        /* 地图容器 */
        #map-container { width: 100%; height: 100%; z-index: 1; }

        /* --- 顶部搜索条 --- */
        .search-bar {
            position: absolute; top: 20px; left: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px; pointer-events: none; /* 让底下地图可点 */
            max-width: 600px; margin: 0 auto;
        }
        .search-bar input {
            pointer-events: auto; flex: 1; padding: 12px 15px; border-radius: 25px; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; transition: all 0.3s;
        }
        .search-bar input:focus { outline: none; box-shadow: 0 4px 15px rgba(0,123,255,0.3); }
        .search-bar button {
            pointer-events: auto; padding: 0 25px; background: #007bff; color: white;
            border: none; border-radius: 25px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: bold; transition: background 0.3s;
        }
        .search-bar button:hover { background: #0056b3; }

        /* --- 底部功能栏 --- */
        .action-bar {
            position: absolute; bottom: 40px; right: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 15px; align-items: flex-end;
        }
        .btn {
            padding: 12px 24px; background: white; border: none; border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center; color: #333;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn.primary { background: #007bff; color: white; }
        .btn-icon { margin-right: 8px; }

        .user-badge {
            background: rgba(255, 255, 255, 0.9); padding: 4px 8px; border-radius: 4px; 
            font-size: 12px; color: #666; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-right: 5px;
        }
        .logout-link { font-size: 12px; color: #dc3545; text-decoration: underline; cursor: pointer; background: none; border: none; padding: 0;}

        /* --- 弹窗样式 --- */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 999;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal {
            background: white; padding: 25px; border-radius: 16px; width: 85%; max-width: 360px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal h3 { margin-top: 0; color: #333; text-align: center; margin-bottom: 20px; }
        .form-item { margin-bottom: 15px; }
        .form-item label { display: block; margin-bottom: 8px; color: #555; font-size: 14px; font-weight: 500;}
        .form-item input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .form-item input:focus { border-color: #007bff; outline: none; }
        
        .modal-btns { display: flex; justify-content: space-between; gap: 15px; margin-top: 25px; }
        .modal-btns button { flex: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        .btn-confirm { background: #007bff; color: white; }

        /* --- 图标选择器样式 --- */
        .type-selector { display: flex; gap: 10px; margin-top: 5px; }
        .type-option {
            flex: 1; border: 2px solid #f0f0f0; border-radius: 10px; padding: 12px 5px;
            text-align: center; cursor: pointer; transition: all 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #888; font-size: 12px; background: #fafafa;
        }
        .type-option i { font-size: 20px; margin-bottom: 6px; color: #ccc; transition: color 0.3s; }
        /* 选中状态 */
        .type-option.active { border-color: #007bff; background-color: #eef7ff; color: #007bff; font-weight: bold; }
        .type-option.active i { color: #007bff; }

        /* 自定义高德 InfoWindow 样式修复 */
        .amap-info-content { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 15px; border: none; }
        .amap-info-close { right: 5px !important; top: 5px !important; }
    </style>
</head>
<body>

<div id="app">
    <!-- 地图容器 -->
    <div id="map-container"></div>

    <!-- 顶部搜索 -->
    <div class="search-bar">
        <input v-model="searchText" placeholder="搜索校内地点 (如: 文苑, 教学楼)" @keyup.enter="doSearch">
        <button @click="doSearch"><i class="fas fa-search"></i> 搜索</button>
    </div>

    <!-- 底部操作栏 -->
    <div class="action-bar">
        <!-- 未登录状态 -->
        <button v-if="!user.isLoggedIn" class="btn primary" @click="showLoginModal = true">
            <i class="fas fa-user-graduate btn-icon"></i> 学生认证 / 登录
        </button>
        
        <!-- 已登录状态 -->
        <div v-else style="display: flex; flex-direction: column; align-items: flex-end;">
            <div style="margin-bottom: 10px;">
                <span class="user-badge">学号: {{ user.studentId }}</span>
                <button class="logout-link" @click="logout">退出</button>
            </div>
            <button class="btn primary" @click="startAddMode" :style="isAddingMode ? 'background:#dc3545' : ''">
                <i class="fas" :class="isAddingMode ? 'fa-times' : 'fa-map-marker-alt'"></i>
                <span class="btn-icon"></span>
                {{ isAddingMode ? '取消选点' : '添加新地点' }}
            </button>
            <div v-if="isAddingMode" style="background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; margin-top: 8px;">
                <i class="fas fa-hand-pointer"></i> 请点击地图上的位置
            </div>
        </div>
    </div>

    <!-- 登录弹窗 -->
    <div v-if="showLoginModal" class="modal-mask">
        <div class="modal">
            <h3><i class="fas fa-university" style="color:#007bff"></i> 建大学生认证</h3>
            <div class="form-item">
                <label>手机号</label>
                <input v-model="loginForm.phone" placeholder="请输入手机号" type="tel" maxlength="11">
            </div>
            <div class="form-item">
                <label>验证码 (测试填 1234)</label>
                <input v-model="loginForm.code" placeholder="短信验证码" maxlength="6">
            </div>
            <div class="form-item">
                <label>学号 (入学年份需在5年内)</label>
                <input v-model="loginForm.sid" placeholder="例: 202516101034">
            </div>
            <div class="modal-btns">
                <button class="btn-cancel" @click="showLoginModal = false">取消</button>
                <button class="btn-confirm" @click="handleLogin">认证并登录</button>
            </div>
        </div>
    </div>

    <!-- 添加地点弹窗 -->
    <div v-if="showAddModal" class="modal-mask">
        <div class="modal">
            <h3><i class="fas fa-map-marked-alt" style="color:#007bff"></i> 标注新地点</h3>
            <p style="font-size:12px; color:#999; margin-bottom: 15px; text-align: center;">
                坐标: {{ tempPoint.lng.toFixed(6) }}, {{ tempPoint.lat.toFixed(6) }}
            </p>
            
            <div class="form-item">
                <label>地点名称</label>
                <input v-model="markerForm.name" placeholder="例如: 北区丰巢快递柜" ref="nameInput">
            </div>
            
            <div class="form-item">
                <label>分类 (点击选择)</label>
                <div class="type-selector">
                    <!-- 选项：生活 -->
                    <label class="type-option" :class="{ active: markerForm.type === '生活' }">
                        <input type="radio" v-model="markerForm.type" value="生活" hidden>
                        <i class="fas fa-store"></i>
                        <span>生活服务</span>
                    </label>

                    <!-- 选项：教学 -->
                    <label class="type-option" :class="{ active: markerForm.type === '教学' }">
                        <input type="radio" v-model="markerForm.type" value="教学" hidden>
                        <i class="fas fa-graduation-cap"></i>
                        <span>教学科研</span>
                    </label>

                    <!-- 选项：景观 -->
                    <label class="type-option" :class="{ active: markerForm.type === '景观' }">
                        <input type="radio" v-model="markerForm.type" value="景观" hidden>
                        <i class="fas fa-tree"></i>
                        <span>校园景观</span>
                    </label>
                </div>
            </div>
            
            <div class="modal-btns">
                <button class="btn-cancel" @click="showAddModal = false">取消</button>
                <button class="btn-confirm" @click="submitMarker">
                    <i class="fas fa-cloud-upload-alt"></i> 提交发布
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 0. 配置中心 (Key与ID配置) ---
    // 高德地图配置
    const AMAP_KEY = '9be3a4a8f5d482a3922a312cd65a211f';

    // LeanCloud 配置 (你提供的)
    const LC_APP_ID = "ECKlruvoxNOQI6zyzg66t5h1-MdYXbMMI";
    const LC_APP_KEY = "B85feGjLyAiFP1OGroH89zfQ";
    const LC_SERVER_URL = "https://ecklruvo.api.lncldglobal.com";

    // --- 1. 定义校园精确边界 (你提供的25个点) ---
    const CAMPUS_PATH = [
        [117.186782,36.687682], // 东北角
        [117.188353,36.683363],
        [117.190676,36.678518], 
        [117.192827,36.672513], 
        [117.187587,36.671103], 
        [117.186199,36.675071], 
        [117.187052,36.675218], 
        [117.187166,36.675492], 
        [117.187127,36.676156], 
        [117.187423,36.676736], 
        [117.187467,36.677393], 
        [117.187284,36.677928], 
        [117.186896,36.678561], 
        [117.186085,36.678934], 
        [117.185601,36.679378], 
        [117.184550,36.679445], 
        [117.179272,36.678990], 
        [117.179052,36.680841], 
        [117.179209,36.681261], 
        [117.179083,36.682586], 
        [117.180417,36.682583], 
        [117.180407,36.686606], 
        [117.180538,36.686644], 
        [117.180546,36.687704]  // 西北角
    ];

    const { createApp, ref, reactive, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- 状态变量 ---
            const map = ref(null);
            const AMapObj = ref(null);
            const searchText = ref("");
            
            const user = reactive({ isLoggedIn: false, studentId: "" });
            const showLoginModal = ref(false);
            const loginForm = reactive({ phone: "", code: "", sid: "" });

            const isAddingMode = ref(false);
            const showAddModal = ref(false);
            const tempPoint = reactive({ lng: 0, lat: 0 });
            const markerForm = reactive({ name: "", type: "生活" });
            const nameInput = ref(null); // 用于聚焦输入框

            // --- 生命周期 ---
            onMounted(() => {
                // 1. 初始化云服务
                if (typeof AV !== 'undefined') {
                    AV.init({ appId: LC_APP_ID, appKey: LC_APP_KEY, serverURL: LC_SERVER_URL });
                }

                // 2. 检查本地登录状态 (Session)
                checkLoginSession();

                // 3. 初始化地图
                initMap();
            });

            // --- 地图初始化核心逻辑 ---
            const initMap = () => {
                AMapLoader.load({
                    key: AMAP_KEY,
                    version: "2.0",
                    plugins: ["AMap.PlaceSearch", "AMap.AutoComplete", "AMap.Scale", "AMap.GeometryUtil", "AMap.ToolBar"], 
                }).then((AMap) => {
                    AMapObj.value = AMap;
                    
                    // 创建地图
                    map.value = new AMap.Map("map-container", {
                        viewMode: "3D",
                        zoom: 15,
                        // 【校准】根据你的新坐标，设置中心点
                        center: [117.186, 36.678], 
                        mask: [CAMPUS_PATH], // 遮罩：只显示校内
                        resizeEnable: true,
                        mapStyle: 'amap://styles/fresh' // 清新风格
                    });

                    // 添加控件 - 使用 addControl 替代 addPlugin
                    map.value.addControl(new AMap.Scale());
                    map.value.addControl(new AMap.ToolBar({ position: 'RB', offset: new AMap.Pixel(10, 120) }));

                    // 限制拖拽范围
                    const polygon = new AMap.Polygon({ path: CAMPUS_PATH });
                    const bounds = polygon.getBounds();
                    map.value.setLimitBounds(bounds);

                    // 【核心】从 LeanCloud 拉取全校数据
                    fetchMarkersFromCloud();

                    // 点击地图事件 (用于添加点)
                    map.value.on('click', (e) => {
                        if (isAddingMode.value) {
                            // 校验是否在校内
                            const isInside = AMap.GeometryUtil.isPointInRing(e.lnglat, CAMPUS_PATH);
                            if (!isInside) {
                                alert("只能在校园范围内标注哦！");
                                return;
                            }
                            // 记录坐标并弹窗
                            tempPoint.lng = e.lnglat.getLng();
                            tempPoint.lat = e.lnglat.getLat();
                            showAddModal.value = true;
                            isAddingMode.value = false; // 关闭选点模式
                            
                            // 自动聚焦输入框
                            nextTick(() => { if(nameInput.value) nameInput.value.focus(); });
                        }
                    });

                }).catch(e => {
                    console.error(e);
                    // 【关键修改2】显示具体的错误信息
                    const errMsg = e.message || JSON.stringify(e) || "未知错误";
                    alert(`地图加载失败: ${errMsg}\n\n请检查：\n1. Key 是否选择了【Web端(JS API)】\n2. 安全密钥(Security Code)是否匹配`);
                });
            };

            // --- 云服务交互 (LeanCloud) ---
            
            // 1. 拉取数据
            const fetchMarkersFromCloud = async () => {
                if (!AV) return;
                try {
                    const query = new AV.Query('CampusMarkers');
                    query.descending('createdAt'); // 最新的在上面
                    query.limit(500); // 限制数量防止卡顿
                    const results = await query.find();
                    
                    results.forEach(record => {
                        const data = record.toJSON();
                        if (data.location) {
                            renderMarker({
                                name: data.name,
                                type: data.type,
                                author: data.author,
                                position: [data.location.longitude, data.location.latitude]
                            });
                        }
                    });
                    console.log(`已加载云端 ${results.length} 个地点`);
                } catch (error) {
                    // 第一次运行时表可能不存在，这不算错误
                    if(error.code !== 101) console.error("数据拉取失败:", error);
                }
            };

            // 2. 上传数据
            const submitMarker = async () => {
                if (!markerForm.name) { alert("请填写地点名称"); return; }
                
                // 构建 LeanCloud 对象
                const MarkerClass = AV.Object.extend('CampusMarkers');
                const newMarker = new MarkerClass();

                newMarker.set('name', markerForm.name);
                newMarker.set('type', markerForm.type);
                newMarker.set('author', user.studentId);
                newMarker.set('status', 0); // 0: 正常/待审核
                // 存储地理位置
                const point = new AV.GeoPoint(tempPoint.lat, tempPoint.lng);
                newMarker.set('location', point);

                try {
                    await newMarker.save();
                    alert("发布成功！您的标注已同步给全校同学。");
                    
                    // 立即在本地渲染
                    renderMarker({
                        name: markerForm.name,
                        type: markerForm.type,
                        author: user.studentId,
                        position: [tempPoint.lng, tempPoint.lat]
                    });
                    
                    showAddModal.value = false;
                    markerForm.name = "";
                } catch (error) {
                    console.error(error);
                    alert("发布失败，请检查网络");
                }
            };

            // --- 地图渲染逻辑 ---
            const renderMarker = (data) => {
                if(!map.value || !AMapObj.value) return;
                
                // 根据类型选择不同的图标颜色或样式 (简单起见这里用统一图标，但弹窗内容不同)
                let iconContent = '<div style="color:#007bff; font-size:24px;"><i class="fas fa-map-marker-alt"></i></div>';
                if(data.type === '生活') iconContent = '<div style="color:#28a745; font-size:24px;"><i class="fas fa-store"></i></div>';
                if(data.type === '教学') iconContent = '<div style="color:#17a2b8; font-size:24px;"><i class="fas fa-graduation-cap"></i></div>';
                if(data.type === '景观') iconContent = '<div style="color:#fd7e14; font-size:24px;"><i class="fas fa-tree"></i></div>';

                const marker = new AMapObj.value.Marker({
                    position: new AMapObj.value.LngLat(data.position[0], data.position[1]),
                    content: iconContent, // 使用自定义图标
                    anchor: 'bottom-center',
                    offset: new AMapObj.value.Pixel(0, 0)
                });
                
                // 详情弹窗
                const infoContent = `
                    <div style="padding:5px 0;">
                        <h4 style="margin:0 0 5px 0; color:#333;">${data.name}</h4>
                        <div style="font-size:12px; color:#666; display:flex; gap:10px; align-items:center;">
                            <span style="background:#f0f0f0; padding:2px 6px; border-radius:4px;">${data.type}</span>
                            <span><i class="fas fa-user"></i> ${data.author}</span>
                        </div>
                    </div>
                `;

                marker.on('click', () => {
                    const infoWindow = new AMapObj.value.InfoWindow({
                        content: infoContent,
                        offset: new AMapObj.value.Pixel(0, -30)
                    });
                    infoWindow.open(map.value, marker.getPosition());
                });

                map.value.add(marker);
            };

            // --- 业务逻辑：搜索 ---
            const doSearch = () => {
                if(!searchText.value) return;
                AMapObj.value.plugin(["AMap.PlaceSearch"], function() {
                    const placeSearch = new AMapObj.value.PlaceSearch({
                        pageSize: 10,
                        pageIndex: 1,
                        map: map.value,
                        autoFitView: true 
                    });
                    // 多边形内搜索
                    const polygon = new AMapObj.value.Polygon({ path: CAMPUS_PATH });
                    placeSearch.searchInBounds(searchText.value, polygon);
                });
            };

            // --- 业务逻辑：账号校验 ---
            const validateAccount = (sid) => {
                if(!sid || sid.length < 10) return { valid: false, msg: "学号长度错误" };
                const yearStr = sid.substring(0, 4);
                const enrollYear = parseInt(yearStr);
                const currentYear = new Date().getFullYear();
                if (isNaN(enrollYear)) return { valid: false, msg: "学号格式错误" };
                if (currentYear - enrollYear > 5) {
                    return { valid: false, msg: "您的账号已超过5年有效期，无法使用编辑功能。" };
                }
                return { valid: true };
            };

            // --- 业务逻辑：登录与会话 ---
            const handleLogin = () => {
                if (loginForm.code !== "1234") { alert("验证码错误 (测试请输入 1234)"); return; }
                const check = validateAccount(loginForm.sid);
                if (!check.valid) { alert(check.msg); return; }

                user.isLoggedIn = true;
                user.studentId = loginForm.sid;
                // 保存会话
                localStorage.setItem("user_session", JSON.stringify(user));
                showLoginModal.value = false;
                alert(`欢迎回来，${user.studentId}！您现在可以添加校园地点了。`);
            };

            const checkLoginSession = () => {
                const stored = localStorage.getItem("user_session");
                if (stored) {
                    const u = JSON.parse(stored);
                    const check = validateAccount(u.studentId);
                    if (!check.valid) {
                        localStorage.removeItem("user_session");
                    } else {
                        user.isLoggedIn = true;
                        user.studentId = u.studentId;
                    }
                }
            };

            const logout = () => {
                localStorage.removeItem("user_session");
                window.location.reload();
            };

            const startAddMode = () => {
                isAddingMode.value = !isAddingMode.value; // 切换模式
            };

            return {
                map, searchText, user, showLoginModal, loginForm,
                isAddingMode, showAddModal, markerForm, tempPoint, nameInput,
                handleLogin, logout, startAddMode, submitMarker, doSearch
            };
        }
    }).mount('#app');
</script>

</body>
</html>